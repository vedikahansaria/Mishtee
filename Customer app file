# --- REPLACEMENT FUNCTION FOR SECTION 3 ---

def process_login(phone_number):
    """
    Orchestrator: Validates user -> Gets Name -> Gets History -> Gets Trending.
    """
    # 1. Define Empty DataFrames (Safety Fallbacks)
    empty_hist = pd.DataFrame(columns=["Date", "Order ID", "Qty (Kg)", "Amount (₹)", "Status"])
    empty_trend = pd.DataFrame(columns=["Sweet Name", "Variant", "Total Sold (Kg)", "Price/Kg (₹)"])
    
    # 2. Input Validation
    if not phone_number:
        return "⚠️ Please enter a phone number.", empty_hist, empty_trend

    try:
        # 3. Get Trending Data (Always fetch this)
        trending_data = get_trending_products()
        if trending_data.empty:
            trending_data = empty_trend

        # 4. Get Customer Details
        cust_resp = supabase.table("customers").select("full_name").eq("phone", phone_number).execute()
        
        # Check if customer exists
        if not cust_resp.data:
            return "Namaste! Account not found. Please sign up!", empty_hist, trending_data
        
        # If customer exists, get name
        name = cust_resp.data[0]['full_name']
        greeting = f"## Namaste, {name} ji! Great to see you again."

        # 5. Get Order History
        orders_resp = supabase.table("orders")\
            .select("order_date, order_id, status, order_value_inr, qty_kg")\
            .eq("cust_phone", phone_number)\
            .order("order_date", desc=True)\
            .execute()
            
        if orders_resp.data:
            hist_df = pd.DataFrame(orders_resp.data)
            # Rename columns to look nice
            hist_df = hist_df.rename(columns={
                "order_date": "Date",
                "order_id": "Order ID",
                "status": "Status",
                "order_value_inr": "Amount (₹)",
                "qty_kg": "Qty (Kg)"
            })
            # Select specific columns
            hist_df = hist_df[["Date", "Order ID", "Qty (Kg)", "Amount (₹)", "Status"]]
        else:
            hist_df = empty_hist

        return greeting, hist_df, trending_data

    except Exception as e:
        # Error Handler
        print(f"Login Error: {e}")
        return f"⚠️ System Error: {str(e)}", empty_hist, empty_trend
